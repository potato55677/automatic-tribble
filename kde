#!/bin/bash
set -e  # Exit immediately if any command fails

# Configuration
USERNAME="kdeuser"
PASSWORD="root"  # Change this for security
CRP=""
PIN="123456"
AUTOSTART=true

# Cleanup function for error handling
cleanup() {
    echo "Error occurred. Performing cleanup..."
    sudo deluser "$USERNAME" 2>/dev/null || true
    sudo rm -rf "/home/$USERNAME"
    exit 1
}
trap cleanup ERR

echo "Creating User and Setting Privileges"
sudo useradd -m -s /bin/bash "$USERNAME"
echo "$USERNAME:$PASSWORD" | sudo chpasswd
sudo usermod -aG sudo,chrome-remote-desktop "$USERNAME"

echo "Updating System and Installing Dependencies"
sudo apt update
sudo apt upgrade -y
sudo apt install -y --no-install-recommends \
    kde-plasma-desktop \
    plasma-workspace-wayland \
    kwin-wayland \
    xorg \
    dbus-x11 \
    sddm \
    tightvncserver \
    wget \
    curl \
    neofetch \
    plasma-nm \
    plasma-pa \
    kio-extras

echo "Configuring Display Manager"
sudo systemctl disable gdm3 2>/dev/null || true
sudo systemctl disable lightdm 2>/dev/null || true
sudo systemctl enable sddm
sudo systemctl set-default graphical.target

echo "Installing Chrome Remote Desktop"
wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
sudo dpkg -i chrome-remote-desktop_current_amd64.deb || sudo apt install -yf
rm chrome-remote-desktop_current_amd64.deb

echo "Optimizing KDE Configuration"
sudo tee /etc/sysctl.d/99-kde-optimizations.conf <<EOF
vm.swappiness=10
vm.vfs_cache_pressure=50
EOF

sudo mkdir -p /etc/xdg/kioslaverc
sudo tee /etc/xdg/kioslaverc <<EOF
[Desktop Entry]
DefaultApplication=org.kde.dolphin
EOF

echo "Configuring User Environment"
sudo -u "$USERNAME" mkdir -p "/home/$USERNAME/.config/autostart"
sudo -u "$USERNAME" dbus-launch kdeglobals

echo "Setting Up Chrome Remote Desktop Session"
sudo tee /etc/chrome-remote-desktop-session <<EOF
export XDG_SESSION_TYPE=x11
exec /usr/bin/startplasma-x11
EOF

if [ "$AUTOSTART" = true ]; then
    sudo -u "$USERNAME" tee "/home/$USERNAME/.config/autostart/colab.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=Colab
Exec=sensible-browser https://youtu.be/d9ui27vVePY?si=TfVDVQOd0VHjUt_b
Icon=
Comment=Auto-start predefined notebook
X-GNOME-Autostart-enabled=true
EOF
fi

echo "Final Configuration"
read -p "Enter CRP value: " CRP
sudo -u "$USERNAME" -E chrome-remote-desktop --pin="$PIN" --code="$CRP"

echo "Optimizing Services"
sudo systemctl disable NetworkManager-wait-online.service
sudo systemctl mask plymouth-quit-wait.service
sudo systemctl enable chrome-remote-desktop

echo "Cleaning Up"
sudo apt autoremove -y
sudo apt clean
sudo rm -rf /var/lib/apt/lists/*

echo "Installation Complete!"
echo "KDE Plasma Version: $(plasmashell --version)"
neofetch

# Keep container running
while :; do sleep 3600; done
